# KB Folder Manager 用户手册

## 1. 简介
KB Folder Manager 是用于个人知识库整理的 Windows/Python 工具，提供：
- Split：把 Complete 拆成 Doc/Res
- Merge：把 Doc/Res 合并回 Complete
- Validate：校验文件夹是否合规
- Index：生成带哈希与元数据的索引

核心原则：
- Complete 目录严格只读
- 占位符为“空文件夹”，用来替代被移走的文件
- 操作遵循“预检 -> 用户确认 -> 执行 -> 后检”闭环

## 2. 环境准备
1. 安装 Python 3.10+（建议）
2. 安装依赖：

```powershell
pip install -r requirements.txt
```

## 3. 配置文件
默认配置文件为 `config.yaml`，关键字段：
- `specified_types`: Doc 侧保留的文件类型列表（按“最后一个后缀”识别）
- `placeholder_suffix`: 占位符后缀（必须是合法文件名组成部分）
- `hash_algorithm`: 哈希算法，默认 `sha256`

注意：
- `placeholder_suffix` 是保留标记，真实目录名严禁以该后缀结尾
- 如需修改类型列表，请保持小写并确保带点号前缀（如 `.pdf`）

## 4. 命令使用
所有命令均可加 `--yes` 跳过确认提示。

### 4.1 Split（拆分）
```powershell
python kb_folder_manager.py split --source D:\Data\MyKB --output-root D:\Output\SplitRun
```
可选参数：
- `--force`：输出目录非空时继续（谨慎）

输出结构：
```
OutputRoot\
  doc\<FolderName>\...
  res\<FolderName>\...
  index\
    complete\.kb_index.json
    doc\.kb_index.json
    res\.kb_index.json
  logs\<timestamp>\Split_pre_check.log
  logs\<timestamp>\Split.log
```

### 4.2 Merge（合并）
```powershell
python kb_folder_manager.py merge --doc D:\Output\SplitRun\doc\MyKB --res D:\Output\SplitRun\res\MyKB --output-root D:\Output\MergeRun
```
要求：`doc` 与 `res` 的文件夹名必须完全一致，否则会 FATAL 终止。

输出结构：
```
OutputRoot\
  complete\<FolderName>\...
  index\complete\.kb_index.json
  logs\<timestamp>\Merge_pre_check.log
  logs\<timestamp>\Merge.log
```

### 4.3 Index（生成索引）
```powershell
python kb_folder_manager.py index --target D:\Data\MyKB --output D:\Output\index.json --log-dir D:\Output\logs
```

### 4.4 Validate（验证）
Class1（基础与环境，Complete/Doc/Res 通用）：
```powershell
python kb_folder_manager.py validate --target D:\Data\MyKB --mode class1 --role complete --log-dir D:\Output\logs
```

Class2（类型纯净度，仅 Doc/Res）：
```powershell
python kb_folder_manager.py validate --target D:\Output\SplitRun\doc\MyKB --mode class2 --role doc --log-dir D:\Output\logs
```

Doc/Res 相互验证（结构一致性与互补性）：
```powershell
python kb_folder_manager.py validate --mode mutual --doc D:\Output\SplitRun\doc\MyKB --res D:\Output\SplitRun\res\MyKB --log-dir D:\Output\logs
```

新旧一致性验证（Hash/Size 必须一致，mtime 不一致为 Warning）：
```powershell
python kb_folder_manager.py validate --mode compare --old D:\Data\MyKB --new D:\Output\Merged\complete\MyKB --log-dir D:\Output\logs
```

`--role` 取值：`complete` / `doc` / `res`（Class1/2 使用；Class2 必须是 doc/res）

## 5. 关键规则提示
- 禁止使用 UNC 网络路径，必须本地路径
- 占位符目录必须为空，非空会被判定为 ERROR
- 合并时遇到占位符目录（名称以 placeholder_suffix 结尾）会被忽略
- 输出目录若非空必须使用 `--force`，否则程序直接中止
- 日志按时间戳分目录保存，避免覆盖
- 大批量文件处理会周期输出进度日志（默认每 200 个文件）

## 6. 常见问题
**Q: 为什么提示“output root not empty”？**  
A: 输出根目录必须为空，或使用 `--force`。

**Q: 占位符目录被云盘忽略怎么办？**  
A: 上传或备份 Split 结果时务必同时保存 `index` 目录。

**Q: 发现合并冲突怎么办？**  
A: 先停止操作，确认 Doc/Res 是否被人为修改，再重新运行预检。

## 7. 建议使用流程
1. Split 前先运行 `validate --mode class1 --role complete`
2. Split 后查看日志，确认无 ERROR/FATAL
3. Merge 前确保 Doc/Res 配对正确（目录名一致）
4. Merge 后检查日志并保留 `index` 与 `logs`
