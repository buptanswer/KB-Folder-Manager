# **KB Folder Manager（Windows / Python）项目需求与设计文档 (v2.8 \- Final Release Candidate)**

## **0\. 背景与目标**

这是一个用于个人知识库文件管理的工具，主要用于将一个混杂了各种文件的“完整文件夹”，按类型拆分成“文档文件夹”和“资源文件夹”，或者将拆分后的两个文件夹合并回原样。

**核心目标：**

1. **拆分（Split）**：把 Complete 拆成 Doc（指定类型）和 Res（其他类型），互补的文件用占位符替代。  
2. **合并（Merge）**：把 Doc和 Res 合并回 Complete，还原真实文件。  
3. **校验（Validate）**：在操作前后进行自动化检查，确保文件没丢、没坏、没乱。  
4. **索引（Index）**：生成包含文件树、哈希、元数据的 JSON 索引，用于比对。

**适用场景：**

供内部使用，处理个人知识库。数据量适中，用户（你）清楚自己在做什么。

## **1\. 核心概念与定义**

### **1.1 文件夹类型**

* **完整文件夹（Complete Folder）**：  
  * 原始输入。包含所有文件。  
  * **权限**：**严格只读**。程序不允许修改其中的任何字节。  
* **文档文件夹（Doc Folder）**：  
  * 拆分产物 A。  
  * **内容**：只包含“指定类型”的真实文件。  
  * **占位符**：原有的“其他类型”文件，在此处替换为 **占位符**。  
* **资源文件夹（Res Folder）**：  
  * 拆分产物 B。  
  * **内容**：只包含“其他类型”的真实文件。  
  * **占位符**：原有的“指定类型”文件，在此处替换为 **占位符**。

### **1.2 指定类型（Specified Types）**

主要指 AI 知识库可解析的文档类型。

* **配置处理**：读取配置列表时，需执行以下步骤：  
  1. **去空**：移除空字符串。  
  2. **转小写**：统一转换为小写。  
  3. **补点**：确保以 . 开头（如 yaml \-\> .yaml）。  
  4. **校验**：检查是否有重复项、格式是否合法。  
* **判定规则**：以文件名最后一个后缀为准。无后缀文件视为“其他类型”。

**默认列表（可配置）：**

见 4.1 节详细列表。

### **1.3 占位符（Placeholder）**

为了保持文件夹结构一致，移走的文件将由一个**纯空文件夹**替代，详细信息记录在索引中。

* **形态**：**空文件夹**（纯净目录，不包含任何文件）。  
* **命名规则**：原文件名（含原后缀） \+ placeholder\_suffix  
  * 示例：report.pdf (被移走) \-\> report.pdf(在百度网盘) (文件夹)  
* **数据记录（索引层）**：  
  * 文件系统层面只是一个空目录。  
  * **关键信息**（如原始文件名、类型标记）全部记录在 .kb\_index.json 中（kind: "placeholder\_dir"）。  
* **指定后缀**：默认为 (在百度网盘)，需在配置中可改。  
* **后缀合法性校验**：placeholder\_suffix 必须是合法的文件/目录名组成部分（不能为空，不得包含 \\ / : \* ? " \< \> |，且不能全为空格），否则程序启动时应报错。  
* **保留标记警告**：placeholder\_suffix 是本工具的**保留标记**。用户的真实目录命名**严禁**以此后缀结尾，否则会被工具误判为占位符并在合并时被忽略（一类验证中会对此进行 FATAL 拦截）。  
* **云端同步提示**：  
  * 部分云存储/同步工具可能会忽略空文件夹。  
  * **建议**：在上传/备份 Split 后的文件夹时，**务必连同 index 目录一起打包或上传**。索引文件是恢复结构的最后一道防线。

**⚠️ 关键规则（Merge 必读）：**

在合并（Merge）操作扫描源目录时，**判定占位符的唯一标准是“目录名称以 placeholder\_suffix 结尾”**。

* **风险提示**：代码遍历时极易将其当作普通目录处理。  
* **强制逻辑**：遇到以此后缀结尾的目录，必须视为占位符并**忽略该目录**（不进入递归，不创建到 Complete 中）。

## **2\. 业务流程与功能模块**

**设计原则**：所有操作均需要“输入 \-\> 预检(输出日志) \-\> 用户确认 \-\> 执行 \-\> 后检(输出日志)”的闭环流程。

**日志策略**：为避免多次运行日志覆盖，建议在 logs 目录下按时间戳创建子目录（如 logs\\2026-01-26\_120000\\...）存放当次运行的所有日志。

### **模块 A：拆分（Split）**

**目标**：Complete \-\> Doc \+ Res \+ 索引/日志

**详细流程**：

1. **用户输入**：  
   * 源路径：Source\_Complete\_Path（**注意**：用户直接输入包含数据的文件夹路径）。  
   * 输出根目录：Output\_Root  
2. **拆分前置检验（Pre-check）**：  
   * **动作**：  
     1. **输出目录检查（安全锁）**：检查 Output\_Root。若不存在则创建；**若存在且非空，必须报错 FATAL 并终止程序**（除非用户在命令行显式指定了 \--force 参数）。  
     2. 扫描源文件夹，生成索引，保存至 Output\_Root\\index\\complete\\.kb\_index.json。  
     3. 执行 **“完整文件夹-一类自身验证”**（见第3节）。  
   * **输出**：若有异常，将问题写入 Output\_Root\\logs\\...\\Split\_pre\_check.log。  
   * **交互**：程序暂停，提示用户查看日志。若有问题，用户手动修正后**重新运行**；若无问题，输入“y”确认。  
3. **执行拆分（Execution）**：  
   * **关于输出路径结构**：  
     * 定义 \<FolderName\> \= basename(Source\_Complete\_Path)（即源路径的最后一级目录名）。  
     * 示例：若源路径为 D:\\Data\\MyKB，则 \<FolderName\> 为 MyKB。  
   * **动作**：  
     1. 遍历源文件夹索引。  
     2. **Doc 生成**：  
        * 若文件是指定类型 \-\> 复制真实文件（保留元数据 copy2）。  
        * 若文件是其他类型 \-\> 创建占位符（**仅创建空文件夹**）。  
        * 索引记录：标记为 placeholder\_dir。  
        * 输出路径：Output\_Root\\doc\\\<FolderName\>。  
     3. **Res 生成**：  
        * 若文件是指定类型 \-\> 创建占位符（**仅创建空文件夹**）。  
        * 若文件是其他类型 \-\> 复制真实文件（保留元数据 copy2）。  
        * 索引记录：标记为 placeholder\_dir。  
        * 输出路径：Output\_Root\\res\\\<FolderName\>。  
     4. **目录结构保持**：源文件夹中的空目录，在 Doc 和 Res 中都应创建对应的空目录，**确保文件夹结构与源文件夹完全一致**。  
   * **索引落盘**：拆分同时生成 Doc 和 Res 的索引文件，分别保存至：  
     * Output\_Root\\index\\doc\\.kb\_index.json  
     * Output\_Root\\index\\res\\.kb\_index.json  
   * **日志**：过程日志写入 Output\_Root\\logs\\...\\Split.log。  
4. **拆分后置检验（Post-check）**：  
   * **动作**：  
     1. 执行 **“Doc-二类自身验证”** 2\. 执行 **“Res-二类自身验证”** 3\. 执行 **“Doc与Res-相互合理性验证”**

### **模块 B：合并（Merge）**

**目标**：Doc \+ Res \-\> Merged Complete \+ 索引/日志

**详细流程**：

1. **用户输入**：  
   * Doc 路径：Source\_Doc\_Path  
   * Res 路径：Source\_Res\_Path  
   * 输出根目录：Output\_Root  
2. **合并前置检验（Pre-check）**：  
   * **动作**：  
     1. **输出目录检查（安全锁）**：检查 Output\_Root。若存在且非空，必须报错 **FATAL**（除非 \--force）。  
     2. **输入源一致性校验（关键）**：检查 basename(Source\_Doc\_Path) 是否严格等于 basename(Source\_Res\_Path)。如果不一致（例如试图合并 KB\_2023 和 KB\_2024），说明配对错误，必须报 **FATAL** 并终止。  
     3. 扫描 Doc 和 Res，生成索引（若未指定特定路径，建议临时生成或复用 Output\_Root\\index 结构，但不应覆盖 Split 产生的原始记录，建议使用 Output\_Root\\index\\merge\_check\_doc\\.kb\_index.json 等路径，或仅在内存中处理）。  
     4. 执行 **全套检查**（写入对应日志）：  
        * Doc/Res 各自的二类验证（纯净度）。  
        * Doc与Res 相互验证（结构一致性、互补性）。  
        * Doc/Res 各自的一类验证（基础合规）。  
   * **交互**：若有导致合并冲突的错误（如两边都是真实文件），**必须中断**；无问题则用户确认。  
3. **执行合并（Execution）**：  
   * **动作**：  
     1. 对比 Doc 和 Res 的索引，生成合并清单。  
     2. **重建**：  
        * 目标路径：Output\_Root\\complete\\\<FolderName\>（FolderName 取自 basename(Source\_Doc\_Path)，此时已确保两边一致）。  
        * **预先创建目录结构（关键防线）**：必须依据 Doc/Res 的目录清单（包括空目录）预先创建所有“普通目录”（dirs），仅跳过占位符目录；**严禁**只依赖复制文件时顺带创建目录，否则会丢失空目录结构并导致逆向拆分验证失败。  
        * 遇到真实文件（无论在 Doc 还是 Res） \-\> 复制到目标。  
        * **遇到占位符**（关键）：检测到目录名称以 placeholder\_suffix 结尾，直接 **忽略该目录**，不执行任何复制或创建操作。  
     3. **冲突处理**：如果两边对同一路径都是真实文件。  
        * *策略*：虽然前置检验会拦截，但若在执行阶段仍发现冲突，记录 **FATAL ERROR 并立即终止合并过程**（Safety First，防止覆盖或产生混合数据）。  
   * **索引**：生成合并后的索引 \-\> Output\_Root\\index\\complete\\.kb\_index.json。  
   * **日志**：过程日志写入 Output\_Root\\logs\\...\\Merge.log。  
4. **合并后置检验（Post-check）**：  
   * **逻辑**：为了确保合并结果 100% 还原，采用“逆向拆分验证法”。  
   * **动作**：  
     1. 程序内部（逻辑上）将新生成的 Output\_Root\\complete 再次尝试拆分成 Temp\_Doc 和 Temp\_Res。  
     2. **验证一致性**：Temp\_Doc vs Source\_Doc 以及 Temp\_Res vs Source\_Res 应完全一致（**注**：此次比对更加简单，因为占位符都是标准空目录，无内部文件差异）。

### **模块 C：工具箱（单独调用）**

提供单独的入口供用户手动执行特定任务。

**设计原则**：工具箱的子模块（索引、验证）即为 Split 和 Merge 流程中调用的底层功能，**参数接口与日志行为必须保持一致**。

1. **建立索引（Index Generator）**：  
   * 输入：目标文件夹路径 Target\_Path、输出路径、日志路径。  
   * 行为：调用核心索引生成函数。  
2. **执行验证（Validator）**：  
   * 输入：待验证文件夹路径、验证模式、日志路径。  
   * 行为：复用主流程中的校验逻辑。

## **3\. 验证规则详解**

### **3.1 索引与错误处理策略**

**索引 Schema 示例（伪 JSON，仅作结构示意）**

为了保证开发一致性，规定索引 JSON **以相对路径（相对于根目录）为主键**。

**关键规则：**

1. **新增 kind: "placeholder\_dir"**：用于明确标识占位符目录。  
2. **索引互斥规则（重复收录检查）**：placeholders 中的路径 **不得** 同时出现在 dirs 中。即：若一个目录被识别为占位符，它只能存在于 placeholders 列表；若它出现在 dirs 列表中，则视为普通目录（这通常意味着验证失败或 Bug）。

{

"files": {

"reports/2023\_summary.pdf": {

"kind": "file",

"size": 102456,

"mtime": 1706256000.0,

"hash": "a1b2c3d4...",

"hash\_alg": "sha256"

}

},

"dirs": {

"reports": { "kind": "dir" }

},

"placeholders": {

"videos/demo.mp4(在百度网盘)": {

"kind": "placeholder\_dir",

"placeholder\_for\_name": "demo.mp4",

"placeholder\_suffix": "(在百度网盘)"

}

},

"metadata": {

"root\_path": "D:\\\\Data\\\\MyKB",

"generated\_at": "2026-01-26T12:00:00"

}

}

*(注：JSON 不支持注释，开发时请遵循标准 JSON 格式)*

**错误处理与中断策略：**

* **单文件复制/Hash失败**：默认 **ERROR 并中断**。  
* **Hash 校验失败**：Hash 不一致 \-\> **ERROR**；Mtime 不一致但 Hash 一致 \-\> **WARNING**。

### **3.2 一类自身合理性验证（基础与环境）**

**目的**：检查文件夹是否“干净”、“合法”。

**适用**：Complete (拆分前), Doc/Res (合并前)

**检查项**：

1. **环境预检（关键）**：  
   * **路径/文件名过长**：建议使用 \\\\?\\ 前缀。  
   * **网络路径（UNC）检测**：若检测到输入/输出为网络路径，**直接报错（FATAL ERROR）**，强制要求本地操作。  
   * **大小写冲突**：检查是否存在仅大小写不同的文件名。  
2. **非法文件名/特殊文件**：Windows 保留字、符号链接 \-\> **FATAL**。  
3. **占位符残留（范围明确）**：  
   * **Complete**：**绝对不应包含** 以“指定后缀”结尾的文件/目录。若发现，说明源文件已经被“污染”，报 FATAL。  
   * **Doc/Res**：**允许存在** 占位符。  
     * **校验规则**：若目录名以 placeholder\_suffix 结尾，则其内部 **必须绝对为空**（不应包含任何文件或子目录）。  
     * **纯净度**：若占位符目录内非空（例如包含 .DS\_Store 或其他文件），视为 **ERROR**。

### **3.3 二类自身合理性验证（类型纯净度）**

**适用**：Doc, Res

**检查项**：

1. **Doc 规则**：真实文件必须是指定类型；占位符必须对应其他类型。  
2. **Res 规则**：真实文件必须是其他类型；占位符必须对应指定类型。  
   **诊断逻辑**：  
   * **拆分后**发现错误 \-\> **工具 Bug**。  
   * **合并前**发现错误 \-\> **用户行为**（用户手动加了文件）。

### **3.4 相互合理性验证（匹配与互补）**

**场景 A：Doc vs Res（互补性）**

* 规则：同一路径下，一边是真实文件，另一边必须是对应的占位符。  
* 异常：冲突（两边都是文件）、丢失（两边都是占位符）、目录树不一致（**注**：目录树一致性比较对象 \= dirs ∪ placeholders，即普通目录 \+ 占位符目录路径都参与结构一致性判断）。

**场景 B：New vs Old（一致性）**

* 规则：Hash、Size 必须完全一致。

### **3.5 路径长度与网络路径支持**

* **长路径**：底层文件操作使用 \\\\?\\ 前缀。  
* **UNC 网络路径**：**严禁使用**。一类验证阶段直接拦截。

## **4\. 关键实现细节与配置**

### **4.1 配置文件 (config.yaml)**

\# 类型定义：AI 知识库常用格式

\# 注意：此列表仅为示例，用户应根据实际需求进行裁剪或扩充。

\# 使用标准 YAML 列表格式，避免解析错误

specified\_types: \[

'.pdf', '.doc', '.docx', '.xlsx', '.xls', '.ppt', '.pptx',

'.txt', '.xmind', '.asset',

'.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.tiff', '.tif', '.svg',

'.md', '.markdown',

'.mp4', '.mkv', '.avi', '.mov', '.wmv', '.flv', '.rmvb', '.srt',

'.mp3', '.wav', '.flac', '.aac', '.ogg',

'.py', '.java', '.c', '.cpp', '.js', '.html', '.css', '.json', '.xml', '.yaml', '.sh', '.ino',

'.drawio', '.csv'

\]

\# 占位符设置

\# 模式：纯文件夹模式，无 marker 文件

placeholder\_suffix: "(在百度网盘)"

\# 哈希设置

hash\_algorithm: "sha256"

use\_7zip: true \# 优先调用 7z.exe