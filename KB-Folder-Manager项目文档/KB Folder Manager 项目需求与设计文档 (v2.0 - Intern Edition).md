# **KB Folder Manager（Windows / Python）项目需求与设计文档 (v2.0 \- Intern Edition)**

## **0\. 背景与目标**

这是一个用于个人知识库文件管理的工具，主要用于将一个混杂了各种文件的“完整文件夹”，按类型拆分成“文档文件夹”和“资源文件夹”，或者将拆分后的两个文件夹合并回原样。

**核心目标：**

1. **拆分（Split）**：把 Complete 拆成 Doc（指定类型）和 Res（其他类型），互补的文件用占位符替代。  
2. **合并（Merge）**：把 Doc和 Res 合并回 Complete，还原真实文件。  
3. **校验（Validate）**：在操作前后进行自动化检查，确保文件没丢、没坏、没乱。  
4. **索引（Index）**：生成包含文件树、哈希、元数据的 JSON 索引，用于比对。

**适用场景：**

供内部使用，处理个人知识库。数据量适中，用户（你）清楚自己在做什么。

## **1\. 核心概念与定义**

### **1.1 文件夹类型**

* **完整文件夹（Complete Folder）**：  
  * 原始输入。包含所有文件。  
  * **权限**：**严格只读**。程序不允许修改其中的任何字节。  
* **文档文件夹（Doc Folder）**：  
  * 拆分产物 A。  
  * **内容**：只包含“指定类型”的真实文件。  
  * **占位符**：原有的“其他类型”文件，在此处替换为 **占位符**。  
* **资源文件夹（Res Folder）**：  
  * 拆分产物 B。  
  * **内容**：只包含“其他类型”的真实文件。  
  * **占位符**：原有的“指定类型”文件，在此处替换为 **占位符**。

### **1.2 指定类型（Specified Types）**

主要指 AI 知识库可解析的文档类型。

* **配置处理**：读取配置时需做去空、转小写、补点操作（如 yaml \-\> .yaml）。  
* **判定规则**：以文件名最后一个后缀为准。无后缀文件视为“其他类型”。

**默认列表（可配置）：**

.pdf, .doc, .docx, .txt, .md, .png, .jpg, .py, .json, .yaml ... (完整列表见配置文件)

### **1.3 占位符（Placeholder）**

为了保持文件夹结构一致，移走的文件需要留下一个标记。

* **当前实现（选项1）**：**空文件夹**。  
* **命名规则**：原文件名 \+ 原后缀 \+ 指定后缀  
  * 示例：report.pdf (被移走) \-\> report.pdf(在百度网盘) (空文件夹)  
* **指定后缀**：默认为 (在百度网盘)，需在配置中可改。

## **2\. 业务流程与功能模块**

**设计原则**：所有操作均需要“输入 \-\> 预检(输出日志) \-\> 用户确认 \-\> 执行 \-\> 后检(输出日志)”的闭环流程。

### **模块 A：拆分（Split）**

**目标**：Complete \-\> Doc \+ Res \+ 索引/日志

**详细流程**：

1. **用户输入**：  
   * 源路径：Source\_Complete\_Path  
   * 输出根目录：Output\_Root  
2. **拆分前置检验（Pre-check）**：  
   * **动作**：  
     1. 扫描源文件夹，生成索引，保存至 Output\_Root\\index\\complete\\.kb\_index.json。  
     2. 执行 **“完整文件夹-一类自身验证”**（见第3节）。  
   * **输出**：若有异常（如非法文件名、已存在占位符），将问题写入 Output\_Root\\logs\\Split\_pre\_check.log。  
   * **交互**：程序暂停，提示用户查看日志。若有问题，用户手动修正源文件后**重新运行**；若无问题，用户输入“y”确认继续。  
3. **执行拆分（Execution）**：  
   * **动作**：  
     1. 遍历源文件夹索引。  
     2. **Doc 生成**：  
        * 若文件是指定类型 \-\> 复制真实文件（保留元数据 copy2）。  
        * 若文件是其他类型 \-\> 创建占位符空文件夹。  
        * 输出路径：Output\_Root\\doc\\\<FolderName\>。  
     3. **Res 生成**：  
        * 若文件是指定类型 \-\> 创建占位符空文件夹。  
        * 若文件是其他类型 \-\> 复制真实文件（保留元数据 copy2）。  
        * 输出路径：Output\_Root\\res\\\<FolderName\>。  
     4. **空目录处理**：源文件夹中的空目录，在 Doc 和 Res 中都应创建对应的空目录。  
   * **索引**：  
     * 拆分同时生成 Doc 索引 \-\> Output\_Root\\index\\doc\\.kb\_index.json  
     * 拆分同时生成 Res 索引 \-\> Output\_Root\\index\\res\\.kb\_index.json  
   * **日志**：过程日志写入 Output\_Root\\logs\\Split.log。  
4. **拆分后置检验（Post-check）**：  
   * **动作**：  
     1. 执行 **“Doc-二类自身验证”** \-\> 日志：Output\_Root\\logs\\Split\_done\_check\\doc.log  
     2. 执行 **“Res-二类自身验证”** \-\> 日志：Output\_Root\\logs\\Split\_done\_check\\res.log  
     3. 执行 **“Doc与Res-相互合理性检验”** \-\> 日志：Output\_Root\\logs\\Split\_done\_check\\doc\_res.log

### **模块 B：合并（Merge）**

**目标**：Doc \+ Res \-\> Merged Complete \+ 索引/日志

**详细流程**：

1. **用户输入**：  
   * Doc 路径：Source\_Doc\_Path  
   * Res 路径：Source\_Res\_Path  
   * 输出根目录：Output\_Root  
2. **合并前置检验（Pre-check）**：  
   * **动作**：  
     1. 扫描 Doc 和 Res，生成索引保存至 Output\_Root\\index\\doc 和 Output\_Root\\index\\res。  
     2. 执行 **全套检查**（写入对应日志）：  
        * Doc 二类验证 \-\> logs\\Merge\_pre\_check\\doc\_B.log  
        * Res 二类验证 \-\> logs\\Merge\_pre\_check\\res\_B.log  
        * Doc与Res 相互验证 \-\> logs\\Merge\_pre\_check\\doc\_res.log  
        * Doc 一类验证 \-\> logs\\Merge\_pre\_check\\doc\_A.log  
        * Res 一类验证 \-\> logs\\Merge\_pre\_check\\res\_A.log  
   * **交互**：查看日志，若有导致合并冲突的错误（如两边都是真实文件，或都有占位符），必须中断；无问题则用户确认。  
3. **执行合并（Execution）**：  
   * **动作**：  
     1. 对比 Doc 和 Res 的索引，生成合并清单。  
     2. **重建**：  
        * 在 Output\_Root\\complete\\\<FolderName\> 创建。  
        * 遇到真实文件（无论在 Doc 还是 Res） \-\> 复制到目标。  
        * 遇到占位符 \-\> **忽略**（不复制）。  
        * 遇到目录 \-\> 创建目录。  
     3. **冲突处理**：如果两边对同一路径都是真实文件（逻辑错误），记录 ERROR 并跳过/中断。  
   * **索引**：生成合并后的索引 \-\> Output\_Root\\index\\complete\\.kb\_index.json。  
   * **日志**：过程日志写入 Output\_Root\\logs\\Merge.log。  
4. **合并后置检验（Post-check）**：  
   * **动作**：  
     1. 执行 **“新Complete与源Doc 相互验证”** \-\> logs\\Merge\_done\_check\\doc\_doc.log  
     2. 执行 **“新Complete与源Res 相互验证”** \-\> logs\\Merge\_done\_check\\res\_res.log

### **模块 C：工具箱（单独调用）**

提供单独的入口供用户手动执行特定任务，逻辑与上述流程中的子步骤一致。

1. **建立索引**：输入任意文件夹 \-\> 输出索引到指定位置。  
2. **执行验证**：输入文件夹路径 \-\> 选择验证类型（一类/二类/相互） \-\> 输出日志。

## **3\. 验证规则详解**

为了简化开发，验证逻辑分为以下几类标准动作：

### **3.1 索引结构（基础）**

所有验证基于生成的 JSON 索引，索引需包含：路径、类型（文件/文件夹）、大小、修改时间(mtime)、哈希(SHA256)。

* **注意**：生成索引时，应自动忽略本工具生成的临时文件（如 .kb\_ 开头的文件）和日志文件。

### **3.2 一类自身合理性验证（基础合规性）**

**目的**：检查文件夹是否“干净”、“合法”。

**适用**：Complete (拆分前), Doc/Res (合并前)

**检查项**：

1. **非法文件名**：是否存在 Windows 保留字 (CON, PRN...) 或以点/空格结尾的文件。 \-\> **报错(FATAL)**  
2. **特殊文件**：是否存在符号链接 (Symlink/Junction)。 \-\> **报错(FATAL)** (个人知识库不应包含这些，简化处理直接报错让用户删)。  
3. **占位符残留**：  
   * 对于 Complete：不应包含以“指定后缀”结尾的文件/目录。  
   * 对于 Doc/Res：除合法的占位符外，不应包含奇怪的“指定后缀”文件。

### **3.3 二类自身合理性验证（类型纯净度）**

**目的**：检查拆分/分类是否正确。

**适用**：Doc, Res

**检查项**：

1. **Doc**：  
   * 所有真实文件 **必须是** 指定类型。  
   * 所有占位符 **必须对应** 其他类型。  
2. **Res**：  
   * 所有真实文件 **必须是** 其他类型。  
   * 所有占位符 **必须对应** 指定类型。  
* **异常**：若发现 Doc 里有 mp4 视频，或 Res 里有 docx 文档，记录 **ERROR**。

### **3.4 相互合理性验证（匹配与互补）**

**目的**：检查两个文件夹是否“天生一对”。

**场景 A：Doc vs Res（互补性）**

* **规则**：  
  * 同一路径下：一边是真实文件，另一边 **必须** 是对应的占位符。  
  * 目录结构：除了占位符的区别外，目录树应一致。  
* **异常**：两边都是文件（冲突）、两边都是占位符（丢失）、找不到对应项。

**场景 B：New vs Old（一致性）**

* **规则**：  
  * 对比两个同类型文件夹（如 Doc\_Source vs Doc\_New\_Split）。  
  * 文件应完全一致（Hash, Size, Mtime）。  
* **异常**：Hash 不同（文件被改过）、文件缺失。

## **4\. 关键实现细节与配置**

### **4.1 配置文件 (config.yaml)**

\# 类型定义  
specified\_types: \[".pdf", ".doc", ".docx", ".txt", ".jpg", ".png", "yaml"\] \# 程序需自动净化格式

\# 占位符设置  
placeholder\_suffix: "(在百度网盘)"

\# 路径设置  
output\_safety\_check: false  \# 是否要求输出目录为空（开发阶段设为false方便调试，实用时建议提示警告）

\# 哈希设置  
hash\_algorithm: "sha256"  
use\_7zip: true  \# 优先尝试调用 7z.exe 加速，失败回退到 Python hashlib  
