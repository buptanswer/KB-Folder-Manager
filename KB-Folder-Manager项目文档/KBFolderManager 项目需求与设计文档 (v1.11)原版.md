# **KB Folder Manager（Windows / Python）项目需求与设计文档 (v1.11 \- User Intent Refined)**

## **0\. 背景与目标**

你有一份 **完整文件夹（complete folder）** ，里面既包含“可被 AI 知识库解析的文件类型（文档/内容类）”，也包含“资源/其他类型文件（附件/素材/杂项）”。你希望：

1. 把完整文件夹拆成两个结构完全一致的新文件夹 ：  
   * 一个只存“指定类型”的文件（简称： **文档文件夹 doc folder** ）  
   * 一个只存“其他类型”的文件（简称： **资源文件夹 res folder** ）  
2. 拆分后必须能 **验证正确性** ，并且 **建立索引（文件树+元数据+哈希）** ，用于后续对比、同步、合并等。  
3. 最终能把 doc folder 与 res folder 重新组合（merge）回一个整体文件夹（merged folder），要求结构一致、占位符被真实文件替换。

### **关键安全要求（强约束）**

* **“我的文件很重要”**： **任何操作过程都不允许修改原文件夹（只读、只复制）**。  
  * *修正（v1.2）：* 针对 complete folder 的索引生成操作，**默认将索引文件写入外部输出目录**。  
  * **统一路径模板**：out/\_index/complete/\<complete\_folder\_name\>/.kb\_index.json。严禁默认写入源目录，仅在用户显式开启 \--write-index-to-source 选项时才允许。  
* **全程完备监控**：需要完备的日志、错误检测、异常处理。过程出错不影响原始数据，必要时中断并提示用户。  
* **占位符规范**：所有占位符后缀 (在百度网盘) 必须是英文括号，并且要求做成 **可修改的全局配置参数** （未来可改短）。

## **1\. 名词与定义**

### **1.1 文件夹类型**

* **完整文件夹（complete folder）** ：原始输入文件夹，包含全部文件与目录结构。**严格只读**。  
* **文档文件夹（doc folder）** ：拆分输出之一， **只包含指定类型** 的真实文件；其他类型用占位符表示。  
* **资源文件夹（res folder）** ：拆分输出之一， **只包含其他类型** 的真实文件；指定类型用占位符表示。  
* **整体文件夹（merged folder）** ：由 doc+res 合并得到的新输出文件夹。

### **1.2 指定类型（specified types）**

“主要是可以被AI知识库解析的类型，文档之类”。

**配置净化规则（v1.1 新增）：** 在加载配置时，必须对类型列表进行“轻量净化”，防止配置脏数据导致分类错误：

1. **Strip**：去除首尾空格/引号（如 ' .yaml ' \-\> .yaml）。  
2. **Lower**：全部转小写。  
3. **补点**：若没有点（如 yaml），自动补齐为 .yaml。  
4. **校验**：若净化后仍非法（如空字符串、仅有一个点），记录 WARNING 日志并忽略该项。

**扩展名判定策略（v1.4 明确）：**

* **规则**：文件类型判定默认取 **最后一个后缀（last suffix）**。  
* **无后缀**：视为“其他类型”，除非用户在配置里显式指定特殊规则。  
* **以点开头**：如 .env，视为扩展名为 .env。

**参考列表：**

{  
  '.pdf', '.doc', '.docx', '.xlsx', '.xls', '.ppt', '.pptx',  
  '.txt', '.xmind', '.asset',  
  '.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.tiff', '.tif', '.svg',  
  '.md', '.markdown',  
  '.mp4', '.mkv', '.avi', '.mov', '.wmv', '.flv', '.rmvb', '.srt',  
  '.mp3', '.wav', '.flac', '.aac', '.ogg',  
  '.py', '.java', '.c', '.cpp', '.js', '.html', '.css', '.json', '.xml', '.yaml', '.sh', '.ino',  
  '.drawio', '.csv'  
}

### **1.3 占位符（placeholder）**

当某个文件被分配到“另一边文件夹”时，在当前文件夹中要建立一个“占位符”来保持结构一致。 **注意**：这里“占位符”是 **空文件夹（directory）** ，不是空文件。

* **占位符命名规则（严格）**  
  placeholder\_name \= \<原文件名(不含扩展名)\> \+ \<.扩展名\> \+ \<placeholder\_tag\>  
  默认 placeholder\_tag \= "(在百度网盘)"（英文括号）  
  * 例：原文件 报告.pdf → 占位符文件夹 报告.pdf(在百度网盘)  
* **可疑占位符（suspicious）**  
  “如果是名称可疑的文件夹（比如以“(在百度网盘)”结尾，但是不严格满足…），标记为可疑，提醒用户手动检查”。

### **1.4 工具产物（Tool Artifacts）（v1.3 新增）**

为了防止程序生成的索引文件、日志文件干扰“内容纯净度检查”和“合并”，定义以下文件为工具产物：

* **定义**：所有文件名以 .kb\_ 开头的文件或目录。  
  * 例如：.kb\_index.json（索引）、.kb\_progress.json（进度）、.kb\_logs/（日志目录）。  
* **规则（隔离原则）**：  
  * **忽略检查**：在执行 doc/res 内容纯净度检查（B1/B2/B4）时，遇到工具产物应直接跳过，**不计入违规文件，不参与比对**。  
  * **忽略合并**：在执行 Merge（C2）时，**严禁将工具产物复制到 merged 文件夹**。  
  * **仅用于管理**：这些文件仅用于读取索引状态或断点续传。

## **2\. 总体功能清单（3 大模块）**

### **模块 A：拆分（Split / Classify）**

**目标** ：把 complete folder 拆为 doc folder \+ res folder，两者内部结构与 complete folder 完全一致（除“缺失文件被占位符替代”）。

#### **A1. 拆分前检查（必须先做）**

执行 split 时，必须先跑一次 **B3（完整文件夹自检）** 。

* 若自检发现严重问题（如大小写冲突、路径过长、**发现非法文件名**、**发现类似占位符的目录**），必须 **FATAL 中断**。  
* 此过程的索引默认写在 out/\_index，不污染源目录。

#### **A2. 输出目录策略（v1.1 强化）**

1. **落地结构**：  
   * output\_base/Document/\<原文件夹名\>/...  
   * output\_base/Resource/\<原文件夹名\>/...  
2. **防覆盖安全检查（默认）**：  
   * 要求目标输出目录（如 output\_base/Document/\<原文件夹名\>）**不存在或必须为空**。  
   * **判空标准（v1.3 明确）**：按目录下是否存在任何条目判断（**包含隐藏文件**，如 desktop.ini）。  
   * 若不为空：直接 **FATAL 报错并退出**（不覆盖、不合并到旧输出）。  
   * *可选*：提供 \--auto-timestamp 参数，自动创建带时间戳的子目录（如 out/run\_20260120\_153012/...）以避免冲突。  
3. **Resume 例外规则（v1.7 新增）**：  
   * 当显式开启 \--resume（或 resume\_enabled=true）时，**允许 doc/res 输出目录非空**，但必须满足：  
     * 目录中存在本工具上次运行生成的 .kb\_progress.json（或等价标识）；  
     * progress 记录的 output\_root / complete\_folder\_name / placeholder\_tag / specified\_types（净化后）等关键参数与本次运行一致；  
   * 否则仍按上述 A2.2 规则直接 **FATAL**（禁止把新运行混入旧输出）。

#### **A3. 拆分规则（核心）**

对 complete folder 进行递归遍历：

1. **大小写冲突预检（v1.1 新增）**：  
   * 遍历目录时，使用 casefold() 检测同一层级是否存在仅大小写不同的文件名（如 a.txt 和 A.txt）。  
   * 若发现冲突：**FATAL 报错**，输出冲突清单，要求用户手动处理（防止在 Windows 默认环境下发生隐式覆盖）。  
2. **符号链接/重解析点检查（v1.4 安全 / v1.7 越界保护）**：  
   * 遇到 symlink 或 junction 默认 **FATAL 中断** 并报告清单（防止递归死循环或越界）。  
   * 仅在 \--follow-links 显式开启时才允许跟随（需记录 Warning）。  
   * **越界保护（v1.7 补丁）**：当 \--follow-links 开启时，跟随链接前必须计算其解析后的 **真实路径（realpath）**。若该路径不在输入根目录（complete/doc/res 的 root）之下，则视为越界，直接 **FATAL**，并输出越界目标清单。  
3. **文件与目录分发（v1.9 修复 \- 空目录保护）**：  
   * **目录处理**：遍历到任意目录节点时（无论其内部是否有文件），必须在 doc 与 res 两侧立即创建对应目录，并在索引中记录为 type: "dir"。这确保空目录结构不丢失。  
   * **文件处理**：  
     * **复制策略（v1.2 明确）**：复制真实文件时，**必须保留元数据**（至少 size/mtime；语义等同于 Python shutil.copy2），以保证后续 B4 校验时时间戳一致。  
     * 若文件扩展名 ∈ specified types：  
       * 真实文件复制到 doc folder。  
       * 在 res folder 创建占位符空文件夹。  
     * 若文件扩展名 ∉ specified types：  
       * 真实文件复制到 res folder。  
       * 在 doc folder 创建占位符空文件夹。  
4. **占位符冲突处理（v1.1 新增）**：  
   * 若目标路径已存在同名占位符目录：**FATAL 报错**（除非 \--resume 且校验该目录确实为空且符合格式）。  
   * 若目标路径已存在同名文件：**FATAL 报错**。

### **模块 B：验证与检测（Validate / Index / Compare）**

**目标** ：对 complete/doc/res 的正确性做系统验证，并生成索引。

#### **B0. 索引文件（Index / Manifest）**

* **文件名**：.kb\_index.json（属于工具产物）  
* **版本控制（v1.4 新增）**：JSON 根节点增加 schema\_version: 1。  
* **排序规则（v1.6 新增）**：entries 列表必须按 logical\_path 升序排序，确保输出确定性。  
* **原子写入（v1.1 明确）**：写入索引时，必须先写入 .kb\_index.json.tmp，写入成功后执行 rename 替换。  
* **内容补全（v1.8 修复）**：entries 中应包含所有目录节点（包括空目录），并显式标记 type: "file" | "dir"。这将确保 Merge 时能重建空目录结构。  
* **存储位置（v1.6 明确）**：  
  * doc / res：写在各自根目录。  
  * complete：默认写在外部目录 index\_base/complete/\<complete\_folder\_name\>/。  
    * 这里的 index\_base 默认等于 output\_base/\_index（即输出侧路径），严禁落到 complete 源目录，仅在 \--write-index-to-source 时写回源目录。  
* **Hash 算法（v1.3 锁死）**：  
  * 默认 **全量 SHA-256**。  
  * **策略**：优先尝试调用系统 7z 命令计算。  
  * **命令标准**：必须强制指定算法，防止 7z 版本差异导致计算出 CRC。  
    * 参考模板：7z h \-scrcSHA256 \-- "\<file\>"  
  * **回退**：若无 7z，使用 Python hashlib 分块读取计算。

#### **B1 & B2. Doc / Res 自身合理性检查**

* **忽略工具产物（v1.3 新增）**：遍历时遇到 .kb\_ 开头的文件/目录，直接跳过，不判定为“类型违规”。  
* 检查内部文件类型是否纯净（doc 只有指定类型，res 只有其他类型）。  
* 检查占位符是否规范，非空占位符视为 **ERROR**（严重错误，因为这会破坏 merge 的确定性）。  
* 生成/更新 .kb\_index.json。

#### **B3. Complete Folder 自身合理性检查**

* **输入**：complete folder 路径。  
* **输出**：日志 \+ 索引文件（默认在外部）。  
* **检查项**：  
  * **占位符混淆风险（v1.2 强化）**：是否存在以占位符后缀结尾（或高度相似）的文件夹。若在 Split 阶段发现，直接 **FATAL 中断**（防混淆）；Validate 阶段报 **ERROR**。  
  * **工具产物命名冲突检查（v1.10 新增）**：检测源目录中是否存在以 .kb\_ 开头的文件或目录。若存在，直接 **FATAL 中断**（因为本工具保留 .kb\_ 前缀作为系统文件，源目录包含此类文件会导致合并时被误过滤，造成数据丢失）。  
  * **Windows 保留/非法文件名检查（v1.5 新增）**：  
    * 检测保留字：CON, PRN, AUX, NUL, COM1-COM9, LPT1-LPT9。  
    * 检测非法末尾：文件名以空格或点结尾。  
    * 发现以上情况直接 **FATAL 中断**（避免后续 IO 错误）。  
  * **符号链接/重解析点（v1.4 / v1.7）**：发现即 FATAL（默认）。若开启跟随，必须校验真实路径越界问题（同 A3）。  
  * 检测文件名过长、深度过深。  
  * 检测大小写冲突。

#### **B4. 两两检验**

* **忽略工具产物（v1.4 补全）**：在生成对比集合或对齐 logical\_path 时，必须显式过滤掉 .kb\_\* 文件，不参与 Hash/Size/Mtime 对比。  
* **Complete vs Doc**：利用索引中的 logical\_path 对齐，忽略占位符差异，对比真实文件。  
  * **对比维度（v1.2 细化）**：Hash（SHA-256）、Size、Mtime。  
  * **判定标准**：  
    * Hash 不一致 → **ERROR**（内容变了）。  
    * Mtime 不一致但 Hash 一致 → **WARNING**（除非开启 strict 模式才报 ERROR）。  
* **Complete vs Res（v1.11 补全）**：  
  * 利用索引中的 logical\_path 对齐。  
  * **指定类型文件**：Complete 中的真实文件应对应 Res 中的占位符目录（命名需严格一致）。  
  * **其他类型文件**：Complete 中的真实文件应对应 Res 中的真实文件（需比对 Hash/Size/Mtime）。  
* **Doc vs Res（互补性）**：  
  * doc 的占位符 \= res 的真实文件。  
  * res 的占位符 \= doc 的真实文件。  
  * **Validate 时发现“占位符目录非空”**：直接 **ERROR**。

### **模块 C：组合（Merge / Rebuild）**

**目标** ：doc \+ res \-\> merged folder。

#### **C1. 合并前置校验（强制）**

1. doc 自检（B1）通过。  
2. res 自检（B2）通过。  
3. 互补性检验（B4）通过。  
* **安全兜底（v1.6 新增）**：若索引中存在任何标记为 copy\_failed 或 hash\_failed 的条目，默认 **拒绝合并**（视为校验未通过）。必须显式使用 \--allow-incomplete-merge 参数才允许合并，并记录 WARN。  
* 若基础校验失败，拒绝合并。

#### **C2. 合并规则**

1. **目标检查**：Merged 输出目录必须为空（参考 A2 规则）。  
2. **执行合并**：  
   * **清单来源（v1.4 明确）**：以 B4 互补性校验通过后的 logical\_path 集合（即 doc/res 索引的合集）作为唯一输入，**严禁再次遍历文件系统**，防止产生未校验的新文件。  
   * **结构重建（v1.8/v1.9 修复）**：必须先遍历索引中的 dir 类型条目，重建所有目录结构（含空目录）。  
     * **关键过滤（v1.9 补丁）**：重建目录时，**严禁创建**名称符合“占位符后缀”的目录，也**严禁创建**工具产物目录（.kb\_），仅重建真实内容目录。  
   * 对每个 logical\_path (file)，根据类型从 doc 或 res 复制真实文件。  
   * **忽略工具产物（v1.3 新增）**：严禁复制 .kb\_index.json 或其他 .kb\_ 文件到 merged 文件夹。  
   * **复制策略（v1.2 明确）**：**必须保留元数据**（等同 shutil.copy2），确保合并后的文件与原始文件尽可能一致。  
   * **所有占位符目录均不进入 merged 文件夹**。  
   * 若合并过程中发现目标位置已有文件（非预期冲突）：立即中断。

## **3\. 非功能需求（可靠性 / 安全 / 可用性）**

### **3.1 错误处理与中断策略（v1.1 细化）**

* **单文件复制/Hash失败**：  
  * 默认：**ERROR 并中断**（宁可不改也别瞎改）。  
  * 若开启 \--continue：跳过该文件，并在索引中标记 copy\_failed=true 或 hash\_failed=true，日志记录 ERROR。后续 Compare/Merge 时视该文件为缺失或损坏。  
* **Hash 校验失败**：同上，默认中断。

### **3.2 断点续传（Resume）增强**

* **指纹校验（Fingerprint）**：  
  * completed\_items 不仅存储路径，还需存储轻量指纹（如 size \+ mtime）。  
  * Resume 时，若文件指纹与记录不匹配，视为文件已变更，**强制重新复制/重算 Hash**，避免跳过已修改的文件。  
* **空目录冲突仲裁（v1.7 新增）**：Resume 模式下允许输出目录非空，详见 **A2.3**。

### **3.3 路径长度与网络路径支持**

* **长路径**：坚持使用 \\\\?\\ 前缀策略。  
* **UNC 网络路径（v1.1 新增）**：  
  * 若源/目标是网络共享 \\\\server\\share\\...，对应的长路径形式需要转换为 \\\\?\\UNC\\server\\share\\...。  
  * 程序需自动检测并处理这种前缀转换，否则长路径支持会在网络盘失效。

## **6\. 配置文件（config.yaml）更新版**

**命名统一说明（v1.5）：** 本节键名与 CLI 参数保持映射一致，避免歧义。

\# 指定类型  
specified\_types:  
  \- .pdf  
  \- .doc  
  \- 'yaml'  \# 自动净化为 .yaml  
  \# ...

\# 占位符后缀  
placeholder\_tag: "(在百度网盘)"

\# 路径与安全策略  
output\_safety\_check: true      \# 对应 CLI: 无直接 flag, 属默认行为  
write\_index\_to\_source: false   \# 对应 CLI: \--write-index-to-source  
case\_sensitivity\_check: true   \# 默认行为  
follow\_symlinks: false         \# 对应 CLI: \--follow-links

\# 运行策略  
continue\_on\_error: false       \# 对应 CLI: \--continue  
resume\_enabled: true           \# 对应 CLI: \--resume (或默认开启)  
verify\_fingerprint: true       \# resume 时校验文件指纹

\# 索引与 Hash  
index\_filename: ".kb\_index.json"  
hash\_algorithm: "sha256"  
prefer\_7z: true  
\# (v1.6 注：该模板为参考；实际以本机 7z 版本为准，但必须强制 SHA-256，并且解析时只接受 SHA-256 字段；失败则回退 hashlib)  
7z\_command\_template: '7z h \-scrcSHA256 \-- "{filepath}"'

## **9\. 关键边界情况与处理规则（补充）**

1. **工具产物隔离（v1.3/1.4）**：必须在所有遍历（os.walk / scandir）和对比逻辑中，显式过滤掉 .kb\_ 开头的文件/目录。  
2. **空目录检测（v1.3/v1.7）**：检查目录是否为空时，使用 any(scandir) 逻辑，确保能感知到隐藏文件。Resume 模式下有条件允许非空（见 A2.3）。  
3. **大小写/WSL 兼容**：Windows 下 a.txt 和 A.txt 在同一个文件夹是冲突的，必须遍历检测，发现即 FATAL。  
4. **符号链接（v1.4/v1.7）**：默认拒绝跟随符号链接；若跟随，必须校验越界。  
5. **元数据一致性**：Split 和 Merge 时的复制操作必须使用 copy2 语义保留 mtime。  
   * \***声明（v1.5）**：copy2 仅承诺保留修改时间和访问权限位。对于 Windows 的完整 ACL（用户所有者/审计）、创建时间（ctime）不保证完全一致。本项目仅对 size/mtime 负责。  
6. **占位符污染（v1.9）**：Merge 重建目录时必须显式过滤掉所有“占位符目录”和“工具产物目录”。  
7. **索引原子性**：.kb\_index.json 永远采用 写入 .tmp \-\> replace 的方式落盘。

## **10\. 验收标准（Acceptance Criteria）更新**

### **10.1 Split 验收**

* **安全**：  
  * 若输出目录非空（含隐藏文件），除非满足 Resume 条件（A2.3），否则拒绝运行。  
  * 若源目录有大小写冲突、符号链接越界（v1.7）或 Windows 保留文件名，报错中断。  
* **工具产物**：输出目录中包含 .kb\_index.json，但该文件不被计入 doc/res 的内容统计。  
* **结构完整性（v1.9）**：Complete 中的空目录在 doc/res 中均被正确重建，并在索引中作为 type: dir 存在。  
* **完整**：doc 和 res 结合能完美还原 complete 结构。文件复制保留了修改时间。

### **10.2 Validate 验收**

* **自检通过**：res 文件夹虽然包含 .kb\_index.json（json 属于指定类型），但由于是工具产物，自检结果应为 PASS。  
* **确定性**：生成的索引文件条目已按 logical\_path 排序。  
* **Hash 准确**：使用 7z 计算出的 Hash 与 Python hashlib 计算出的结果一致（均为 SHA-256）。

### **10.3 Merge 验收**

* **安全兜底**：若源 doc/res 索引中包含 copy\_failed 标记，拒绝合并。  
* **来源纯净**：Merge 操作未触发对文件系统的重新扫描，完全基于索引清单执行。  
* **结构还原（v1.9）**：Merge 后的文件夹不仅包含所有文件，也完美还原了原文件夹中的空目录结构，且 **严禁包含** 任何占位符目录。  
* **纯净度**：Merged 文件夹中不存在任何 .kb\_ 开头的工具文件，也不存在占位符目录。